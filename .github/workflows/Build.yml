name: 🛠️ Optimize Resource Pack

on:
  workflow_dispatch:
  push:
    branches: main

permissions:
  contents: write

jobs:
  optimize:
    name: 🗜️ Run PackSquash
    runs-on: ubuntu-latest
    steps:
      - name: 📂 Clone Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🗑️ Remove Failed Workflows
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run list --limit 100 --json databaseId,status \
          | jq -r '.[] | select(.status=="failed" or .status=="cancelled") | .databaseId' \
          | xargs -I {} gh run delete {} -y

      - name: 🗜️ Run PackSquash
        uses: ComunidadAylas/PackSquash-action@v4
        with:
          packsquash_version: latest-unstable
          artifact_name: 'Conquest'
          options: |
            pack_directory = '.'
            output_file_path = 'Conquest.zip'
            allow_mods = ['OptiFine', 'Minecraft Transit Railway 3']
            zip_spec_conformance_level = 'high'
            spooling_buffers_size = 2048
            color_quantization_target = 'none'
            threads = 12
            zip_compression_iterations = 40
            ['**/*?.ogg']
            ogg_obfuscation = true
            ['**/*?.png']
            image_data_compression_iterations = 128
            maximum_width_and_height = 4096