name: 🍃 Sync 1.21-leafless With 1.21

on:
  push:
    branches:
      - "1.21"  # Runs whenever a commit is pushed to 1.21

jobs:
  sync-branch:
    name: 🔄 Sync 1.21-leafless With 1.21
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures full history for cherry-picking

      - name: 🕵🏻 Set Git Identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: 🔄 Switch To 1.21-leafless
        run: git checkout 1.21-leafless

      - name: 🍒 Cherry-Pick New Commits From 1.21
        run: |
          git checkout 1.21
          git log 1.21-leafless..1.21 --pretty=format:"%H" | tac | while read commit; do
            git checkout 1.21-leafless
            git cherry-pick -X theirs $commit || (git cherry-pick --abort && echo "Conflict detected, skipping commit $commit")
          done

      - name: ➡️ Push Changes To 1.21-leafless
        run: |
          git checkout 1.21-leafless
          git push origin 1.21-leafless